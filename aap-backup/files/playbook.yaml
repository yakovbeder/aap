- name: AAP export playbook with private GitHub integration
  hosts: localhost
  gather_facts: false
  collections:
    - ansible.controller
  environment:
    CONTROLLER_HOST: "{{ lookup('env','CONTROLLER_HOST') }}"
    CONTROLLER_USERNAME: "{{ lookup('env','CONTROLLER_USERNAME') }}"
    CONTROLLER_PASSWORD: "{{ lookup('env','CONTROLLER_PASSWORD') }}"
    CONTROLLER_VERIFY_SSL: false

  vars:
    # --- GitHub Configuration ---
    github_repo_url: "{{ lookup('env','GITHUB_REPO_URL') }}"
    github_repo_dir: "/tmp/aap_backups"
    # --- Kubernetes Secret Paths ---
    github_user_secret_path: "/etc/github-credentials/username"
    github_password_secret_path: "/etc/github-credentials/password"

  tasks:
    #######################################################################
    # 1Ô∏è‚É£ Read and decode service account token
    #######################################################################
    - name: Read service account token
      slurp:
        src: "/var/run/secrets/kubernetes.io/serviceaccount/token"
      register: sa_token_raw

    - name: Decode service account token
      set_fact:
        sa_token: "{{ sa_token_raw['content'] | b64decode }}"

    #######################################################################
    # 2Ô∏è‚É£ Authenticate to OpenShift
    #######################################################################
    - name: Login to OpenShift using service account token
      shell: |
        oc login --token="{{ sa_token }}" --server="https://kubernetes.default.svc" --insecure-skip-tls-verify=true
      environment:
        KUBECONFIG: /tmp/kubeconfig
      register: oc_login

    #######################################################################
    # 3Ô∏è‚É£ Read GitHub credentials from mounted secret
    #######################################################################
    - name: Read GitHub username from secret
      set_fact:
        github_user: "{{ lookup('file', github_user_secret_path) }}"

    - name: Read GitHub password from secret
      set_fact:
        github_password: "{{ lookup('file', github_password_secret_path) }}"
      no_log: true # IMPORTANT: Prevents password/token from appearing in logs

    #######################################################################
    # 4Ô∏è‚É£ Set authenticated GitHub repo URL
    #######################################################################
    - name: Set authenticated GitHub repo URL
      set_fact:
        github_repo_url_auth: "https://{{ github_user }}:{{ github_password | urlencode }}@{{ github_repo_url.split('://')[1] }}"
      no_log: true # IMPORTANT: Prevents the full URL with password from being logged

    #######################################################################
    # 5Ô∏è‚É£ Clone GitHub repository
    #######################################################################
    - name: Clone GitHub repository
      ansible.builtin.git:
        repo: "{{ github_repo_url_auth }}"
        dest: "{{ github_repo_dir }}"
        clone: yes
        update: yes
      environment:
        GIT_SSL_NO_VERIFY: "true"
      no_log: true # Hide the repo URL in logs

    #######################################################################
    # 6Ô∏è‚É£ Prepare timestamp and backup file name
    #######################################################################
    - name: Set timestamp
      set_fact:
        timestamp: "{{ lookup('pipe', 'date +%Y%m%d-%H%M%S') }}"

    - name: Set output file path
      set_fact:
        export_file: "{{ github_repo_dir }}/{{ lookup('env','BACKUP_PREFIX') }}-{{ timestamp }}.yaml"

    #######################################################################
    # 7Ô∏è‚É£ Export only inventories (not all assets)
    #######################################################################
    - name: Export inventories
      ansible.controller.export:
        inventories: true
      register: export_results
      retries: 5
      delay: 15
      until: export_results is succeeded

    #######################################################################
    # 8Ô∏è‚É£ Write exported data to YAML file
    #######################################################################
    - name: Write to output file
      copy:
        content: "{{ export_results.stdout | from_json | to_nice_yaml(width=50, explicit_start=true, explicit_end=true) }}"
        dest: "{{ export_file }}"

    #######################################################################
    # 9Ô∏è‚É£ Add and commit new backup file
    #######################################################################
    - name: Add and commit new backup file
      shell: |
        git config --global user.email "aap-backup@example.com"
        git config --global user.name "AAP Backup Bot"
        git add .
        git commit -m "Add backup for {{ timestamp }}"
      args:
        chdir: "{{ github_repo_dir }}"

    #######################################################################
    # üîü Push new backup to GitHub
    #######################################################################
    - name: Push new backup to GitHub
      shell: git push origin main # Or your default branch
      args:
        chdir: "{{ github_repo_dir }}"
      environment:
        GIT_SSL_NO_VERIFY: "true"

    #######################################################################
    # 1Ô∏è‚É£1Ô∏è‚É£ Rotate old backups (keep latest 20 files)
    #######################################################################
    - name: Get list of existing export files
      find:
        paths: "{{ github_repo_dir }}"
        patterns: "{{ lookup('env','BACKUP_PREFIX') }}-*.yaml"
        file_type: file
      register: export_files

    - name: Remove oldest files if more than 20 exist
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ export_files.files | sort(attribute='mtime') | reverse | slice(20) }}"
      when: export_files.matched > 20
      register: deleted_files

    #######################################################################
    # 1Ô∏è‚É£2Ô∏è‚É£ Commit and push deleted files
    #######################################################################
    - name: Commit and push deleted files
      shell: |
        git add . --all
        git commit -m "Cleanup: Remove old backups"
        git push origin main # Or your default branch
      args:
        chdir: "{{ github_repo_dir }}"
      when: deleted_files.changed
      environment:
        GIT_SSL_NO_VERIFY: "true"
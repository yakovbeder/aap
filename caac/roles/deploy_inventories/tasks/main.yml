---
# ========================================================================
# Load inventory definitions from exported files or fallback to manual vars
# ========================================================================
- name: Find exported inventory files
  find:
    paths: "{{ playbook_dir }}/files"
    patterns: "export-results-*.yaml"
    file_type: file
  register: exported_files

- name: Load exported inventory data from files
  set_fact:
    exported_data: "{{ exported_data | default([]) + [(lookup('file', item.path) | from_yaml)] }}"
  loop: "{{ exported_files.files }}"
  when: exported_files.matched > 0

- name: Transform exported inventories format (flatten organization.name to organization)
  set_fact:
    controller_inventories: "{{ controller_inventories | default([]) + [{
      'name': inv.name,
      'organization': inv.organization.name,
      'description': inv.description | default('') | string
    }] }}"
    inventory_hosts: "{{ inventory_hosts | default({}) | combine({ inv.name: inv.related.hosts | default([]) }) }}"
  loop: "{{ exported_data | map(attribute='inventory') | flatten | default([]) }}"
  loop_control:
    label: "{{ inv.name }}"
  vars:
    inv: "{{ item }}"
  when: exported_files.matched > 0

- name: Load manual inventory definitions from role vars if no exported files found
  include_vars:
    file: "{{ role_path }}/vars/main.yml"
    name: role_vars
  when: exported_files.matched == 0

- name: Set controller_inventories from role vars when no files exist
  set_fact:
    controller_inventories: "{{ role_vars.controller_inventories | default([]) }}"
  when: exported_files.matched == 0

- name: Display inventories to be deployed
  debug:
    msg: |
      Source: {{ 'Exported files' if exported_files.matched > 0 else 'Manual vars (roles/deploy_inventories/vars/main.yml)' }}
      Will deploy {{ controller_inventories | length }} inventories: {{ controller_inventories | map(attribute='name') | list }}
  when: controller_inventories is defined and controller_inventories | length > 0

# ========================================================================
# Deploy inventories to AAP Controller
# ========================================================================
- name: "Ensure AAP Inventories are configured"
  ansible.controller.inventory:
    name: "{{ item.name }}"
    organization: "{{ item.organization }}"
    description: "{{ item.description | default(omit) }}"
    state: present
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ generated_token.ansible_facts.controller_token.token }}"
    validate_certs: "{{ controller_validate_certs }}"
  loop: "{{ controller_inventories }}"
  loop_control:
    label: "{{ item.name }}"
  when: controller_inventories is defined and controller_inventories | length > 0
  register: inventory_results

# ========================================================================
# Deploy hosts to inventories
# ========================================================================
- name: "Prepare inventory-host mapping for deployment"
  set_fact:
    inventory_host_mapping: "{{ inventory_host_mapping | default([]) + [{
      'inventory': inv_item.name,
      'organization': inv_item.organization,
      'hosts': inventory_hosts[inv_item.name] | default([])
    }] }}"
  loop: "{{ controller_inventories }}"
  vars:
    inv_item: "{{ item }}"
  when: 
    - exported_files.matched > 0
    - inventory_hosts is defined
    - inventory_hosts[item.name] is defined
    - inventory_hosts[item.name] | length > 0

- name: "Ensure hosts are configured in inventories"
  ansible.controller.host:
    name: "{{ item.1.name }}"
    inventory: "{{ item.0.inventory }}"
    description: "{{ item.1.description | default(omit) }}"
    enabled: "{{ item.1.enabled | default(true) }}"
    variables: "{{ (item.1.variables | trim | from_yaml) if (item.1.variables is string and item.1.variables | trim != '') else (item.1.variables if item.1.variables is mapping else omit) }}"
    state: present
    controller_host: "{{ controller_host }}"
    controller_oauthtoken: "{{ generated_token.ansible_facts.controller_token.token }}"
    validate_certs: "{{ controller_validate_certs }}"
  loop: "{{ inventory_host_mapping | subelements('hosts') }}"
  loop_control:
    label: "{{ item.0.inventory }}/{{ item.1.name }}"
  when: 
    - exported_files.matched > 0
    - inventory_host_mapping is defined
    - inventory_host_mapping | length > 0

